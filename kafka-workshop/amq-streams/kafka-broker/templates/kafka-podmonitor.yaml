apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: {{ include "kafka-broker.name" . }}-podmonitor
  {{- if .Values.namespace }}
  namespace: {{ .Values.namespace }}
  {{- end }}
  labels:
    {{- include "kafka-broker.labels" . | nindent 4 }}
  annotations:
    {{- include "kafka-broker.argocd-syncwave" . | nindent 4 }}
spec:
  selector:
    matchExpressions:
      - key: strimzi.io/kind
        operator: In
        values:
          - Kafka
      - key: strimzi.io/cluster
        operator: In
        values:
          - {{ include "kafka-broker.name" . }} 
  podMetricsEndpoints:
    - path: /metrics
      port: tcp-prometheus
      relabelings:
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(strimzi_io_.+)
          replacement: $1
          separator: ;
        - action: replace
          regex: (.*)
          replacement: $1
          separator: ;
          sourceLabels:
            - __meta_kubernetes_namespace
          targetLabel: namespace
        - action: replace
          regex: (.*)
          replacement: $1
          separator: ;
          sourceLabels:
            - __meta_kubernetes_pod_name
          targetLabel: kubernetes_pod_name
        - action: replace
          regex: (.*)
          replacement: $1
          separator: ;
          sourceLabels:
            - __meta_kubernetes_pod_node_name
          targetLabel: node_name
        - action: replace
          regex: (.*)
          replacement: $1
          separator: ;
          sourceLabels:
            - __meta_kubernetes_pod_host_ip
          targetLabel: node_ip

